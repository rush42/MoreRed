# @package _global_
defaults:
  - override /task: consistency_task
  - override /data: qm7x
  - override /callbacks:
    - checkpoint
    - earlystopping
    - lrmonitor
    - sampling


run:
  work_dir: ${hydra:runtime.cwd}
  data_dir: ${run.work_dir}/data
  path: ${run.work_dir}/runs
  model_dir: ${run.work_dir}/models
  experiment: consistency_model
  id: ${uuid:1}
  dir: consistency_model_#${run.id}
  # ckpt_path: ${run.path}/consistency_lrs/checkpoints/last.ckpt

globals:
  model_path: best_model
  cutoff: 500
  lr: 1.0e-4
  permutation_invariant: true
  rotation_invariant: false
  include_t_0: false
  t_1_bonus: 0.0
  n_atom_basis: 256
  noise_target_key: eps
  noise_output_key: eps_pred
  x_0_output_key: x_0_pred
  time_target_key: t
  x_t_target_key: '_positions'
  denoiser_path: "${run.model_dir}/qm7x_ddpm.pt"
  time_predictor_path: "${run.model_dir}/qm7x_time_predictor.pt"
  split_file_path: ${run.work_dir}/split.npz
  norm_regularization: 0.0
  diffusion_range: 1.0
  monitor_metric: 'val_sampling_rmsd'
  T: 64

  noise_schedule:
    _target_: morered.noise_schedules.PolynomialSchedule
    T: ${globals.T}
    s: 1.0e-05
    dtype: float64
    variance_type: lower_bound

  diffusion_schedule:
    _target_: morered.diffusion_schedule.DiffusionSchedule
    T: ${globals.T}
    
  diffusion_process:
    _target_: morered.processes.VPGaussianDDPM
    noise_schedule: ${globals.noise_schedule}
    invariant: true
    noise_key: ${globals.noise_target_key}
    dtype: float64

  reverse_process:
    _target_: morered.reverse_process.ReverseODE
    diffusion_process: ${globals.diffusion_process}
    noise_pred_key: ${globals.noise_output_key}
    time_key: ${globals.time_target_key}
    denoiser: ${globals.denoiser_path}
    cutoff: ${globals.cutoff}
  # profiler: 
  #   _target_: pytorch_lightning.profiler.AdvancedProfiler
  #   path: ${run.dir}

trainer:
  _target_: pytorch_lightning.Trainer
  devices: 1
  min_epochs: null
  max_epochs: 10000
  enable_model_summary: true
  profiler: null
  # profiler: ${globals.profiler}
  # gradient_clip_val: 50
  accumulate_grad_batches: 1
  val_check_interval: 1.0
  check_val_every_n_epoch: 1
  log_every_n_steps: 5
  num_sanity_val_steps: 0
  fast_dev_run: false
  overfit_batches: 0
  limit_train_batches: 1.0
  limit_val_batches: 1.0
  limit_test_batches: 1.0
  detect_anomaly: false
  precision: 32
  accelerator: auto
  num_nodes: 1
  deterministic: false
  inference_mode: false

task:
  _target_: morered.ConsitencyTask
  reverse_process: ${globals.reverse_process}
  optimizer_cls: torch.optim.AdamW
  ema_decay: 0.99995
  skip_referenceless_batches: false
  skip_exploding_batches: true
  loss_limit: 2.0
  # diffusion_schedule: ${globals.diffusion_schedule}
  optimizer_args:
    lr: ${globals.lr}
    weight_decay: 0.0
  scheduler_cls: schnetpack.train.ReduceLROnPlateau
  scheduler_monitor: ${globals.monitor_metric}
  scheduler_args:
    mode: min
    factor: 0.5
    patience: 1500
    threshold: 0.0
    threshold_mode: rel
    cooldown: 10
    min_lr: 0
    smoothing_factor: 0.0
  warmup_steps: 0
  time_key: ${globals.time_target_key}
  x_t_key: ${globals.x_t_target_key}
  outputs:
    # - _target_: morered.task.ConsistencyModelOutput
    #   name: ${globals.x_0_output_key}
    #   permutation_invariant: ${globals.permutation_invariant}
    #   rotation_invariant: ${globals.rotation_invariant}
    #   loss_fn:
    #     _target_: torch.nn.MSELoss
    #   metrics:
    #     mse:
    #       _target_: torchmetrics.regression.MeanSquaredError
    #       squared: true
    #   loss_weight: 1.0
    # - _target_: morered.task.NormRegularizer
    #   name: ${globals.x_0_output_key}
    #   limit: ${globals.norm_regularization}
    #   loss_weight: 1.0
    - _target_: morered.task.LRSOutput
      name: ${globals.x_0_output_key}
      source_model: ${globals.time_predictor_path}
      loss_fn:
        _target_: torch.nn.MSELoss
      metrics:
        mse:
          _target_: torchmetrics.regression.MeanSquaredError
          squared: true
      loss_weight: 0.01

model:
  _target_: morered.model.consistency_parametrization.ConsistencyParametrization
  initialize_with_denoiser: ${globals.denoiser_path}
  time_key: ${globals.time_target_key}
  input_key: ${globals.x_t_target_key}
  output_key: ${globals.x_0_output_key}
  sigma_data: null
  source_model:
    _target_: schnetpack.model.NeuralNetworkPotential
    representation:
      radial_basis:
        _target_: schnetpack.nn.radial.GaussianRBF
        n_rbf: 20
        cutoff: ${globals.cutoff}
      _target_: schnetpack.representation.PaiNN
      n_atom_basis: ${globals.n_atom_basis}
      n_interactions: 3
      shared_interactions: false
      shared_filters: false
      cutoff_fn:
        _target_: schnetpack.nn.cutoff.CosineCutoff
        cutoff: ${globals.cutoff}

    input_modules:
    - _target_: schnetpack.atomistic.PairwiseDistances

    output_modules:
    - _target_: morered.model.heads.TimeAwareEquivariant
      n_in: ${globals.n_atom_basis}
      n_hidden: null
      n_layers: 3
      output_key: ${globals.x_0_output_key}
      include_time: true
      time_head: null
      detach_time_head: false
      time_key: ${globals.time_target_key}

    do_postprocessing: true

    postprocessors:
    - _target_: morered.transform.BatchSubtractCenterOfMass
      name: ${globals.x_0_output_key}

data:
  _target_: morered.datasets.QM7X
  datapath: ${run.data_dir}/qm7x.db
  data_workdir: null
  batch_size: 225
  split_file: ${globals.split_file_path}
  num_train: null
  num_val: null
  num_test: null
  num_workers: 4
  num_val_workers: null
  num_test_workers: null
  raw_data_path: ${run.data_dir}
  remove_duplicates: true
  only_equilibrium: true
  distance_unit: Ang
  property_units:
    energy: eV
  load_properties:
  - energy
  pin_memory: true
  transforms:
  - _target_: schnetpack.transform.CastTo64
  - _target_: schnetpack.transform.SubtractCenterOfGeometry

  - _target_: morered.transform.Diffuse
    diffuse_property: ${globals.x_t_target_key}
    diffusion_process: ${globals.diffusion_process}
    # diffusion_schedule: ${globals.diffusion_schedule}
    time_key: ${globals.time_target_key}
    include_t_0: ${globals.include_t_0}
    t_1_bonus: ${globals.t_1_bonus}
    diffusion_range: ${globals.diffusion_range}

  - _target_: morered.transform.AllToAllNeighborList

  - _target_: schnetpack.transform.CastTo32

logger:
  tensorboard:
    _target_: pytorch_lightning.loggers.tensorboard.TensorBoardLogger
    save_dir: tensorboard/
    name: default
print_config: true

sampler:
  _target_: morered.sampling.ConsistencySampler
  diffusion_process: ${globals.diffusion_process}
  denoiser: null

callbacks:
  sampling:
    t: 15
    max_steps: 1
    start_epoch: 0
    every_n_epochs: 1
    log_rmsd: True
  early_stopping:
    patience: 1000
    monitor: ${globals.monitor_metric}

matmul_precision: 'high'